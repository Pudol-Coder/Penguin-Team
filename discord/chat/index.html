<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>PENGUIN | KDH Fan Client</title>
    <style>
        body { background-color: #313338; color: #dbdee1; font-family: 'Pretendard', sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        header { background: #313338; padding: 10px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #26272d; }
        .container { display: flex; flex: 1; overflow: hidden; }
        nav { width: 240px; background: #2b2d31; display: flex; flex-direction: column; padding: 10px; flex-shrink: 0; }
        .channel-item { padding: 8px 12px; border-radius: 4px; cursor: pointer; color: #949ba4; margin-bottom: 2px; }
        .channel-item:hover { background: #35373c; color: #dbdee1; }
        .channel-item.active { background: #404249; color: #fff; font-weight: bold; }
        main { flex: 1; display: flex; flex-direction: column; background: #313338; position: relative; }
        #chat-log { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .msg-box { display: flex; gap: 16px; padding: 4px 0; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; background: #4e5058; flex-shrink: 0; }
        .msg-content { flex: 1; min-width: 0; }
        .user-name { font-weight: bold; color: #fff; margin-right: 8px; }
        .msg-date { font-size: 11px; color: #949ba4; }
        .text { line-height: 1.45; font-size: 15px; word-break: break-word; white-space: pre-wrap; }
        
        /* ë§ˆí¬ë‹¤ìš´ ë Œë”ë§ ìŠ¤íƒ€ì¼ */
        .text strong { color: #fff; font-weight: 700; }
        .text h1 { font-size: 1.4em; border-bottom: 1px solid #4e5058; margin: 10px 0; color: #fff; }
        .text h2 { font-size: 1.2em; margin: 8px 0; color: #fff; }
        .text h3 { font-size: 1.1em; margin: 6px 0; color: #fff; }
        .text code { background: #2b2d31; padding: 2px 4px; border-radius: 4px; font-family: Consolas, monospace; }
        .spoiler { background: #1e1f22; color: #1e1f22; cursor: pointer; padding: 0 2px; border-radius: 3px; }
        .spoiler.revealed { background: rgba(255,255,255,0.1); color: inherit; }
        .mention { color: #c9cdfb; background: rgba(88,101,242,0.3); padding: 0 2px; border-radius: 3px; font-weight: 500; }
        .emoji { width: 22px; height: 22px; vertical-align: bottom; margin: 0 1px; }
        .img-preview { max-width: 100%; max-height: 300px; border-radius: 8px; margin-top: 8px; display: block; border: 1px solid #222; }

        .input-area { padding: 0 20px 24px 20px; }
        .input-wrapper { background: #383a40; border-radius: 8px; padding: 10px 15px; display: flex; gap: 10px; }
        #msg-input { background: transparent; border: none; color: #dbdee1; flex: 1; outline: none; }
        .send-btn { background: #5865f2; color: white; border: none; border-radius: 3px; padding: 7px 16px; cursor: pointer; font-weight: bold; }
        .spinning { animation: spin 0.8s linear infinite; }
        @keyframes spin { from {transform: rotate(0deg);} to {transform: rotate(360deg);} }
    </style>
</head>
<body>

<header>
    <div style="display: flex; align-items: center; gap: 10px;">
        <span style="color: #80848e; font-size: 20px;">#</span>
        <h2 id="current-channel-name" style="margin: 0; font-size: 16px;">ê³µì§€</h2>
    </div>
    <div id="usage-timer" style="font-size: 13px; color: #3ba55c; font-weight: bold;">â±ï¸ ë¡œë”© ì¤‘...</div>
</header>

<div class="container">
    <nav id="channel-list"></nav>
    <main>
        <div id="chat-log"></div>
        <div class="input-area">
            <div class="input-wrapper">
                <input type="text" id="msg-input" placeholder="ë©”ì‹œì§€ ë³´ë‚´ê¸°..." onkeypress="handleEnter(event)">
                <button class="send-btn" onclick="sendNotice()">ì „ì†¡</button>
            </div>
        </div>
    </main>
</div>

<script>
    const CHANNELS = [
        { name: "ê³µì§€", id: "1472091143863799849", canSend: false },
        { name: "ì´ë²¤íŠ¸", id: "1472807840740540447", canSend: false },
        { name: "ì±„íŒ…", id: "1472090209276395694", canSend: true },
        { name: "ì¼ìƒ", id: "1472868706760523978", canSend: true }
    ];

    let currentChannelId = CHANNELS[0].id;

    // ğŸ† ë¬´ì ì˜ ë§ˆí¬ë‹¤ìš´ íŒŒì„œ (ì´ ë¶€ë¶„ì´ í•µì‹¬ì…ë‹ˆë‹¤)
    function parseDiscordMarkdown(text) {
        if (!text) return "";

        // 1. ë³´ì•ˆ: HTML íŠ¹ìˆ˜ë¬¸ì ì œê±°
        let rendered = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");

        // 2. ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° (ì¤„ë°”ê¿ˆ ê³ ë ¤)
        const imgRegex = /(https?:\/\/[^\s]+?\.(?:jpg|jpeg|png|gif|webp))/gi;
        rendered = rendered.replace(imgRegex, (url) => `<div><img src="${url}" class="img-preview"></div>`);

        // 3. ì»¤ìŠ¤í…€ ì´ëª¨ì§€ <a:name:id> ë˜ëŠ” <:name:id>
        rendered = rendered.replace(/&lt;a?:(\w+):(\d+)&gt;/g, (match, name, id) => {
            const isAnimated = match.includes('&lt;a:');
            return `<img src="https://cdn.discordapp.com/emojis/${id}.${isAnimated?'gif':'png'}" class="emoji" alt="${name}">`;
        });

        // 4. í—¤ë” (# ) - ì¤„ ì‹œì‘ì ì—ì„œë§Œ ì‘ë™í•˜ë„ë¡ ì •ê·œì‹ ìˆ˜ì •
        rendered = rendered.split('\n').map(line => {
            if (line.startsWith('# ')) return `<h1>${line.substring(2)}</h1>`;
            if (line.startsWith('## ')) return `<h2>${line.substring(3)}</h2>`;
            if (line.startsWith('### ')) return `<h3>${line.substring(4)}</h3>`;
            return line;
        }).join('\n');

        // 5. ì¸ë¼ì¸ ë§ˆí¬ë‹¤ìš´ (ì¤‘ë³µ ë°©ì§€ë¥¼ ìœ„í•´ ë¹„ì‹ë³„ ê¸°í˜¸ ì‚¬ìš© ê°€ëŠ¥ì„± ì°¨ë‹¨)
        rendered = rendered
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/~~(.*?)~~/g, '<del>$1</del>')
            .replace(/`(.*?)`/g, '<code>$1</code>')
            .replace(/\|\|(.*?)\|\|/g, '<span class="spoiler" onclick="this.classList.toggle(\'revealed\')">$1</span>');

        // 6. ë©˜ì…˜
        rendered = rendered.replace(/&lt;@!?(\d+)&gt;/g, '<span class="mention">@ìœ ì €</span>')
                           .replace(/&lt;#(\d+)&gt;/g, '<span class="mention">#ì±„ë„</span>')
                           .replace(/@everyone/g, '<span class="mention">@everyone</span>');

        return rendered;
    }

    async function fetchChat() {
        const chatLog = document.getElementById('chat-log');
        const isBottom = chatLog.scrollHeight - chatLog.scrollTop <= chatLog.clientHeight + 100;

        try {
            const res = await fetch(`/api/get-chat?channelId=${currentChannelId}&limit=20`);
            const data = await res.json();
            const messages = Array.isArray(data) ? data : (data.messages || []);

            chatLog.innerHTML = '';
            [...messages].reverse().forEach(msg => {
                const div = document.createElement('div');
                div.className = 'msg-box';
                div.innerHTML = `
                    <img src="${msg.avatar || ''}" class="avatar" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3588/3588612.png'">
                    <div class="msg-content">
                        <div class="user-header"><span class="user-name">${msg.username}</span><span class="msg-date">ì˜¤ëŠ˜</span></div>
                        <div class="text">${parseDiscordMarkdown(msg.content)}</div>
                    </div>`;
                chatLog.appendChild(div);
            });

            if (isBottom) chatLog.scrollTop = chatLog.scrollHeight;
        } catch (e) { console.error(e); }
    }

    function switchChannel(id, name) {
        currentChannelId = id;
        document.getElementById('current-channel-name').innerText = name;
        renderChannelList();
        fetchChat();
    }

    function renderChannelList() {
        document.getElementById('channel-list').innerHTML = `
            <div style="padding:10px; font-size:12px; color:#949ba4; font-weight:bold;">ì±„ë„ ëª©ë¡</div>
            ${CHANNELS.map(ch => `
            <div class="channel-item ${ch.id === currentChannelId ? 'active' : ''}" onclick="switchChannel('${ch.id}', '${ch.name}')">
                # ${ch.name}
            </div>`).join('')}`;
    }

    async function sendNotice() {
        const input = document.getElementById('msg-input');
        if (!input.value.trim()) return;
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        await fetch('/api/send-chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                channelId: currentChannelId,
                username: `[WEB] ${user.username}`,
                avatar_url: user.avatar ? `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png` : '',
                content: input.value
            })
        });
        input.value = '';
        fetchChat();
    }

    function handleEnter(e) { if (e.key === 'Enter') sendNotice(); }

    window.onload = () => {
        renderChannelList();
        fetchChat();
        setInterval(fetchChat, 5000);
    };
</script>
</body>
</html>
